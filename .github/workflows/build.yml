name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          # Clone to ASA0002E directory to match sketch name (Arduino CLI requirement)
          path: ASA0002E

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Create Arduino CLI config
        working-directory: ASA0002E
        run: |
          mkdir -p .vscode
          cat > .vscode/arduino-cli.yaml << 'EOF'
          directories:
            data: ~/.arduino15
            downloads: ~/.arduino15/staging
            user: ~/Arduino
          board_manager:
            additional_urls:
              - https://arduino.esp8266.com/stable/package_esp8266com_index.json
          EOF
          # Remove leading spaces from the YAML file
          sed -i 's/^          //' .vscode/arduino-cli.yaml

      - name: Install ESP8266 platform
        working-directory: ASA0002E
        run: |
          arduino-cli --config-file .vscode/arduino-cli.yaml core update-index
          # Extract platform version from sketch.yaml using sed (more portable)
          # Format: "platform: esp8266:esp8266 (3.1.2)"
          PLATFORM_VERSION=$(grep 'platform: esp8266:esp8266' sketch.yaml | sed 's/.*(\([0-9.]*\)).*/\1/' 2>/dev/null)
          # Validate version format (should be digits and dots only)
          if ! echo "$PLATFORM_VERSION" | grep -qE '^[0-9]+\.[0-9]+(\.[0-9]+)?$'; then
            echo "Warning: Could not extract valid platform version, using default 3.1.2"
            PLATFORM_VERSION="3.1.2"
          fi
          echo "Installing ESP8266 platform version: ${PLATFORM_VERSION}"
          arduino-cli --config-file .vscode/arduino-cli.yaml core install "esp8266:esp8266@${PLATFORM_VERSION}"

      - name: Install required libraries from sketch.yaml
        working-directory: ASA0002E
        run: |
          # Parse libraries from sketch.yaml and install them
          # Only match lines after "libraries:" that start with "- " and have format "LibraryName (version)"
          # Exclude lines containing "platform:" to avoid matching platform entries
          grep -A100 'libraries:' sketch.yaml | grep -E '^\s+-\s+[^:]+\([^)]+\)' | grep -v 'platform:' | while read -r line; do
            # Extract library name (everything before the last '(' with version)
            lib_name=$(echo "$line" | sed -E 's/^\s*-\s*(.+)\s*\([^)]+\)\s*$/\1/' | sed 's/[[:space:]]*$//')
            # Extract version (content inside the last parentheses)
            lib_version=$(echo "$line" | sed -E 's/.*\(([^)]+)\).*/\1/')
            echo "Installing library: ${lib_name}@${lib_version}"
            arduino-cli --config-file .vscode/arduino-cli.yaml lib install "${lib_name}@${lib_version}" || \
              arduino-cli --config-file .vscode/arduino-cli.yaml lib install "${lib_name}"
          done

      - name: Build firmware
        working-directory: ASA0002E
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Generate build summary
        working-directory: ASA0002E
        run: |
          # Load build information
          source Build/build-info.txt
          
          BIN_FILE="Build/${SKETCH_NAME}.bin"
          MD5_FILE="Build/${SKETCH_NAME}.bin.md5"
          
          # Read MD5 hashes
          MD5_UNCOMPRESSED=$(grep -v "compressed" "$MD5_FILE" | awk '{print $1}')
          MD5_COMPRESSED=$(grep "compressed" "$MD5_FILE" | awk '{print $1}')
          
          # Get build timestamp
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Get repository info
          REPO="${GITHUB_REPOSITORY}"
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          COMMIT_SHA_FULL="${GITHUB_SHA}"
          RUN_ID="${GITHUB_RUN_ID}"
          
          # Calculate sizes in different units
          ORIGINAL_SIZE_KB=$(awk "BEGIN {printf \"%.2f\", ${ORIGINAL_SIZE}/1024}")
          COMPRESSED_SIZE_KB=$(awk "BEGIN {printf \"%.2f\", ${COMPRESSED_SIZE}/1024}")
          FLASH_TOTAL_KB=$(awk "BEGIN {printf \"%.0f\", ${FLASH_SIZE_MB}*1024}")
          FLASH_AVAILABLE_KB=$(awk "BEGIN {printf \"%.2f\", ${FLASH_TOTAL_KB} - ${COMPRESSED_SIZE_KB}}")
          
          # Extract key board parameters for display
          CRYSTAL_FREQ=$(echo "$BOARD_PARAMS" | grep -oP 'CrystalFreq=\K[^,]+' || echo "26")
          FLASH_FREQ=$(echo "$BOARD_PARAMS" | grep -oP 'FlashFreq=\K[^,]+' || echo "40")
          FLASH_MODE=$(echo "$BOARD_PARAMS" | grep -oP 'FlashMode=\K[^,]+' || echo "qio")
          CPU_FREQ=$(echo "$BOARD_PARAMS" | grep -oP 'xtal=\K[^,]+' || echo "80")
          
          # Create the summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸŽ‰ Build Successful!
          
          The firmware has been compiled successfully and is ready for deployment.
          
          ## ðŸ“¦ Firmware Information
          
          | Property | Value |
          |----------|-------|
          | ðŸ“ **Sketch Name** | \`${SKETCH_NAME}\` |
          | ðŸŽ¯ **Board** | \`esp8266:esp8266:generic\` |
          | âš¡ **CPU Frequency** | ${CPU_FREQ} MHz |
          | ðŸ”® **Crystal** | ${CRYSTAL_FREQ} MHz |
          | ðŸ’¾ **Flash Size** | ${FLASH_SIZE_MB} MB |
          | ðŸ“¡ **Flash Mode** | ${FLASH_MODE^^} @ ${FLASH_FREQ} MHz |
          | ðŸ• **Build Time** | ${BUILD_TIME} |
          | ðŸ”– **Commit** | [\`${COMMIT_SHA}\`](https://github.com/${REPO}/commit/${COMMIT_SHA_FULL}) |
          
          ## ðŸ“Š Binary File Details
          
          | File Type | Size (bytes) | Size (KB) | MD5 Hash |
          |-----------|--------------|-----------|----------|
          | ðŸ“„ **Original Binary** | ${ORIGINAL_SIZE} | ${ORIGINAL_SIZE_KB} | \`${MD5_UNCOMPRESSED}\` |
          | ðŸ—œï¸ **Compressed (gzip)** | ${COMPRESSED_SIZE} | ${COMPRESSED_SIZE_KB} | \`${MD5_COMPRESSED}\` |
          
          ### ðŸ“ˆ Compression Statistics
          
          - **Compression Ratio:** ${COMPRESSION_RATIO}% (saved $(awk "BEGIN {printf \"%.2f\", ${ORIGINAL_SIZE_KB} - ${COMPRESSED_SIZE_KB}}") KB)
          - **Compression Method:** gzip level 9
          
          ## ðŸ’¾ Flash Memory Usage
          
          | Metric | Value |
          |--------|-------|
          | ðŸ—œï¸ **Compressed Size** | ${COMPRESSED_SIZE_KB} KB |
          | ðŸ“Š **Flash Usage** | ${FLASH_USAGE_PCT}% of ${FLASH_SIZE_MB} MB |
          | âœ… **Available Space** | ${FLASH_AVAILABLE_KB} KB |
          | ðŸ“¦ **Total Flash** | ${FLASH_TOTAL_KB} KB |
          
          ### ðŸ“Š Usage Visualization
          
          \`\`\`
          Flash: [$(printf 'â–ˆ%.0s' $(seq 1 $((FLASH_USAGE_PCT/2))))$(printf 'â–‘%.0s' $(seq 1 $((50-FLASH_USAGE_PCT/2))))] ${FLASH_USAGE_PCT}%
          \`\`\`
          
          ## ðŸ”§ Build Configuration
          
          <details>
          <summary>Click to expand build flags and parameters</summary>
          
          ### Build Flags
          \`\`\`
          ${BUILD_FLAGS}
          \`\`\`
          
          ### Board Parameters
          \`\`\`
          ${BOARD_PARAMS}
          \`\`\`
          
          </details>
          
          ## ðŸ“¥ Download Firmware
          
          ðŸ”— **[Download Firmware Artifact](https://github.com/${REPO}/actions/runs/${RUN_ID})**
          
          The compiled and compressed firmware binary is available as a workflow artifact along with MD5 checksums and build metadata.
          
          ### ðŸ“¦ Artifact Contents
          
          - \`${SKETCH_NAME}.bin\` - Compressed firmware binary (gzip)
          - \`${SKETCH_NAME}.bin.md5\` - MD5 checksums for verification
          - \`build-info.txt\` - Build configuration and metadata
          
          ## ðŸ” MD5 Checksums
          
          ### Compressed Binary (gzip)
          \`\`\`
          ${MD5_COMPRESSED}
          \`\`\`
          
          ### Original Binary (before compression)
          \`\`\`
          ${MD5_UNCOMPRESSED}
          \`\`\`
          
          ## âœ… Integrity Verification
          
          To verify the firmware integrity after download, use one of these methods:
          
          ### Verify Compressed Binary (recommended)
          \`\`\`bash
          echo "${MD5_COMPRESSED}  ${SKETCH_NAME}.bin" | md5sum -c
          \`\`\`
          
          ### Verify Original Binary (decompress first)
          \`\`\`bash
          gunzip -c ${SKETCH_NAME}.bin > ${SKETCH_NAME}.bin.uncompressed
          echo "${MD5_UNCOMPRESSED}  ${SKETCH_NAME}.bin.uncompressed" | md5sum -c
          \`\`\`
          
          ## ðŸ“š Additional Information
          
          - **Build System:** [Arduino CLI](https://arduino.github.io/arduino-cli/)
          - **Platform:** ESP8266 Arduino Core
          - **Workflow:** [Build Workflow](.github/workflows/build.yml)
          - **Repository:** [${REPO}](https://github.com/${REPO})
          
          ---
          
          âœ¨ *Automatically built by GitHub Actions â€¢ [View Run](https://github.com/${REPO}/actions/runs/${RUN_ID})*
          EOF
          
          echo "âœ… Build summary generated successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: firmware
          path: |
            ASA0002E/Build/*.bin
            ASA0002E/Build/*.md5
            ASA0002E/Build/build-info.txt
          if-no-files-found: error