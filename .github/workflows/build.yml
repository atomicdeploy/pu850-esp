name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          # Clone to a directory with the same name to match the sketch file (Arduino CLI requirement)
          path: ASA0002E

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Create Arduino CLI config
        working-directory: ASA0002E
        run: |
          mkdir -p .vscode
          cat > .vscode/arduino-cli.yaml << 'EOF'
          directories:
            data: ~/.arduino15
            downloads: ~/.arduino15/staging
            user: ~/Arduino
          board_manager:
            additional_urls:
              - https://arduino.esp8266.com/stable/package_esp8266com_index.json
          EOF
          # Remove leading spaces from the YAML file
          sed -i 's/^          //' .vscode/arduino-cli.yaml

      - name: Install ESP8266 platform
        working-directory: ASA0002E
        run: |
          arduino-cli --config-file .vscode/arduino-cli.yaml core update-index
          # Extract platform version from sketch.yaml using awk (more portable)
          # Format: "platform: esp8266:esp8266 (3.1.2)"
          PLATFORM_VERSION=$(grep 'platform: esp8266:esp8266' sketch.yaml | awk -F'[()]' '{print $2}' 2>/dev/null)
          # Validate version format (should be digits and dots only)
          if ! echo "$PLATFORM_VERSION" | grep -qE '^[0-9]+\.[0-9]+(\.[0-9]+)?$'; then
            echo "Warning: Could not extract valid platform version, using default 3.1.2"
            PLATFORM_VERSION="3.1.2"
          fi
          echo "Installing ESP8266 platform version: ${PLATFORM_VERSION}"
          arduino-cli --config-file .vscode/arduino-cli.yaml core install "esp8266:esp8266@${PLATFORM_VERSION}"

      - name: Install required libraries from sketch.yaml
        working-directory: ASA0002E
        run: |
          # Parse libraries from sketch.yaml and install them
          # Only match lines after "libraries:" that start with "- " and have format "LibraryName (version)"
          # Exclude lines containing "platform:" to avoid matching platform entries
          # TODO: make use of a real YAML library instead
          grep -A100 'libraries:' sketch.yaml | grep -E '^\s+-\s+[^:]+\([^)]+\)' | grep -v 'platform:' | while read -r line; do
            # Extract library name and version using awk with index/substr (avoids sed regex issues)
            lib_name=$(echo "$line" | awk '{
              open_paren = index($0, "(")
              if (open_paren > 0) {
                name = substr($0, 1, open_paren - 1)
                gsub(/^[[:space:]]*-[[:space:]]*/, "", name)
                gsub(/[[:space:]]*$/, "", name)
                print name
              }
            }')
            lib_version=$(echo "$line" | awk '{
              open_paren = index($0, "(")
              close_paren = index($0, ")")
              if (open_paren > 0 && close_paren > open_paren) {
                print substr($0, open_paren + 1, close_paren - open_paren - 1)
              }
            }')
            echo "Installing library: ${lib_name}@${lib_version}"
            arduino-cli --config-file .vscode/arduino-cli.yaml lib install "${lib_name}@${lib_version}" || \
              arduino-cli --config-file .vscode/arduino-cli.yaml lib install "${lib_name}"
          done

      - name: Build firmware
        working-directory: ASA0002E
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Export library information
        working-directory: ASA0002E
        run: |
          # Export installed library information to a file for use in the summary
          mkdir -p Build
          if arduino-cli --config-file .vscode/arduino-cli.yaml lib list --json > Build/libraries.json; then
            echo "‚úÖ Library information exported to Build/libraries.json"
          else
            echo "‚ö†Ô∏è Failed to export library information, writing empty JSON array to Build/libraries.json"
            echo "[]" > Build/libraries.json
          fi

      - name: Upload build artifacts
        id: upload_artifacts
        uses: actions/upload-artifact@v6
        with:
          name: firmware
          path: |
            ASA0002E/Build/*.bin
            ASA0002E/Build/*.md5
            ASA0002E/Build/build-info.txt
            ASA0002E/Build/libraries.json
          if-no-files-found: error

      - name: Generate build summary
        working-directory: ASA0002E
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Load build information
          if [ -f Build/build-info.txt ]; then
            source Build/build-info.txt
          else
            echo "‚ùå Error: Build/build-info.txt not found. Ensure build.sh generated this file before running the build summary step." >&2
            exit 1
          fi
          
          BIN_FILE="Build/${SKETCH_NAME}.bin"
          MD5_FILE="Build/${SKETCH_NAME}.bin.md5"
          
          # Ensure MD5 file exists
          if [ ! -f "$MD5_FILE" ]; then
            echo "‚ùå Error: MD5 file '$MD5_FILE' not found. Ensure the build step generated this file." >&2
            exit 1
          fi
          
          # Read MD5 hashes with basic validation
          MD5_UNCOMPRESSED=$(grep -v "compressed" "$MD5_FILE" | awk '{print $1}') || {
            echo "‚ùå Error parsing MD5 file '$MD5_FILE' for uncompressed hash." >&2
            exit 1
          }
          MD5_COMPRESSED=$(grep "compressed" "$MD5_FILE" | awk '{print $1}') || {
            echo "‚ùå Error parsing MD5 file '$MD5_FILE' for compressed hash." >&2
            exit 1
          }
          
          if [ -z "$MD5_UNCOMPRESSED" ] || [ -z "$MD5_COMPRESSED" ]; then
            echo "‚ùå Error: MD5 hashes could not be extracted from '$MD5_FILE' (one or both hashes are empty)." >&2
            exit 1
          fi
          
          # Get build timestamp
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Get repository info
          REPO="${GITHUB_REPOSITORY}"
          COMMIT_SHA_FULL="${GITHUB_SHA}"
          RUN_ID="${GITHUB_RUN_ID}"
          
          # Fetch artifact download URL using GitHub API
          echo "üîç Fetching artifact download URL..."
          ARTIFACT_URL=""
          MAX_RETRIES=5
          DELAY=2
          
          # Retry fetching artifacts until the "firmware" artifact is available (or retries are exhausted)
          for ((i=1; i<=MAX_RETRIES; i++)); do
            echo "üîÅ Attempt $i to fetch artifacts for run ${RUN_ID}..."
            ARTIFACTS_JSON=$(curl -s -H "Authorization: token ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts")
          
            # Extract the artifact ID for "firmware" artifact using jq if available, otherwise grep
            if command -v jq &> /dev/null; then
              ARTIFACT_ID=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name == "firmware") | .id' 2>/dev/null || echo "")
            else
              # Fallback to grep-based parsing with more specific pattern
              ARTIFACT_ID=$(echo "$ARTIFACTS_JSON" | grep -A 5 '"name": "firmware"' | grep -m1 -oP '"id":\s*\K[0-9]+' || echo "")
            fi
          
            if [ -n "$ARTIFACT_ID" ]; then
              break
            fi
          
            if [ "$i" -lt "$MAX_RETRIES" ]; then
              echo "‚è±Ô∏è Artifact not found yet, waiting ${DELAY}s before retrying..."
              sleep "$DELAY"
              DELAY=$((DELAY * 2))
            fi
          done
          
          if [ -n "$ARTIFACT_ID" ]; then
            ARTIFACT_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}/artifacts/${ARTIFACT_ID}"
            echo "‚úÖ Artifact URL: $ARTIFACT_URL"
          else
            echo "‚ö†Ô∏è Could not fetch artifact URL, using run page"
            ARTIFACT_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          fi
          
          # Set locale for thousand separator formatting
          export LC_NUMERIC=en_US.UTF-8
          
          # Calculate sizes in different units (KB with no decimals, rounded)
          ORIGINAL_SIZE_KB=$(awk "BEGIN {printf \"%.0f\", ${ORIGINAL_SIZE}/1024}")
          COMPRESSED_SIZE_KB=$(awk "BEGIN {printf \"%.0f\", ${COMPRESSED_SIZE}/1024}")
          FLASH_TOTAL_KB=$(awk "BEGIN {printf \"%.0f\", ${FLASH_SIZE_MB}*1024}")
          FLASH_AVAILABLE_KB=$(awk "BEGIN {printf \"%.0f\", ${FLASH_TOTAL_KB} - ${COMPRESSED_SIZE_KB}}")
          
          # Calculate flash usage bars for visualization (with bounds checking)
          FLASH_BARS=$((FLASH_USAGE_PCT / 2))
          [ $FLASH_BARS -lt 0 ] && FLASH_BARS=0
          [ $FLASH_BARS -gt 50 ] && FLASH_BARS=50
          
          # Calculate RAM usage bars for visualization (with bounds checking)
          RAM_BARS=$((RAM_USAGE_PCT / 2))
          [ $RAM_BARS -lt 0 ] && RAM_BARS=0
          [ $RAM_BARS -gt 50 ] && RAM_BARS=50
          
          # Parse library list from libraries.json (generated by `arduino-cli lib list --json`)
          # Extract name, version, and website URL for each installed library
          LIBRARY_LIST=""
          if [ -f "Build/libraries.json" ]; then
            LIBRARY_LIST=$(python3 -c 'import json; import re; from urllib.parse import quote_plus; exec("def escape_markdown(text):\n    return re.sub(r\"([\\\\`*_{}[\\]()#+\\-.!|])\", r\"\\\\\\1\", text)\n\ntry:\n    with open(\"Build/libraries.json\", \"r\") as f:\n        data = json.load(f)\n    for lib_info in data.get(\"installed_libraries\", []):\n        lib = lib_info.get(\"library\", {})\n        name = lib.get(\"name\", \"\")\n        version = lib.get(\"version\", \"\")\n        website = lib.get(\"website\", \"\")\n        if not name or not version:\n            continue\n        safe_name = escape_markdown(name)\n        if website:\n            print(f\"| **[{safe_name}]({website})** | `{version}` |\")\n        else:\n            search_url = f\"https://github.com/search?q={quote_plus(name)}&type=repositories\"\n            print(f\"| [{safe_name}]({search_url}) | `{version}` |\")\nexcept Exception as e:\n    import sys\n    print(f\"Error: {e}\", file=sys.stderr)\n")')
          else
            # Fallback to parsing sketch.yaml if libraries.json is not available
            LIBRARY_LIST=$(awk '
              /libraries:/ { in_libs=1; next }
              in_libs && /-/ && /\(/ && /\)/ {
                open_paren = index($0, "(")
                close_paren = index($0, ")")
                if (open_paren > 0 && close_paren > open_paren) {
                  name = substr($0, 1, open_paren - 1)
                  version = substr($0, open_paren + 1, close_paren - open_paren - 1)
                  gsub(/^[[:space:]]*-[[:space:]]*/, "", name)
                  gsub(/[[:space:]]*$/, "", name)
                  # Best-effort URL encoding for spaces in library name (align with Python replace(' ', '+'))
                  gsub(/[[:space:]]+/, "+", name)
                  lib_url = "https://github.com/search?q=" name "&type=repositories"
                  print "| **[" name "](" lib_url ")** | `" version "` |"
                }
              }
              /^[^[:space:]]/ && in_libs && !/libraries:/ { exit }
            ' sketch.yaml)
          fi
          
          # Extract platform version from sketch.yaml before heredoc to avoid command substitution issues
          # Use awk to extract version between parentheses without regex patterns
          PLATFORM_VERSION=$(awk '
            /platform: esp8266:esp8266/ && /\(/ && /\)/ {
              open_paren = index($0, "(")
              close_paren = index($0, ")")
              if (open_paren > 0 && close_paren > open_paren) {
                print substr($0, open_paren + 1, close_paren - open_paren - 1)
                exit
              }
            }
          ' sketch.yaml)
          # Default to Unknown if not found
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="Unknown"
          
          # Extract key board parameters for display
          # Default values are Unknown
          CRYSTAL_FREQ=$(echo "$BOARD_PARAMS" | grep -oP 'CrystalFreq=\K[^,]+' || echo "Unknown")
          FLASH_FREQ=$(echo "$BOARD_PARAMS" | grep -oP 'FlashFreq=\K[^,]+' || echo "Unknown")
          FLASH_MODE=$(echo "$BOARD_PARAMS" | grep -oP 'FlashMode=\K[^,]+' || echo "Unknown")
          CPU_FREQ=$(echo "$BOARD_PARAMS" | grep -oP 'xtal=\K[^,]+' || echo "Unknown")
          
          # Pre-calculate all visualizations and formatted values to avoid command substitution inside heredoc
          # Flash usage visualization
          FLASH_BARS_FILLED=""
          [ $FLASH_BARS -gt 0 ] && FLASH_BARS_FILLED=$(printf '‚ñà%.0s' $(seq 1 $FLASH_BARS))
          FLASH_EMPTY=$((50 - $FLASH_BARS))
          FLASH_BARS_EMPTY=""
          [ $FLASH_EMPTY -gt 0 ] && FLASH_BARS_EMPTY=$(printf '‚ñë%.0s' $(seq 1 $FLASH_EMPTY))
          
          # RAM usage visualization
          RAM_BARS_FILLED=""
          [ $RAM_BARS -gt 0 ] && RAM_BARS_FILLED=$(printf '‚ñà%.0s' $(seq 1 $RAM_BARS))
          RAM_EMPTY=$((50 - $RAM_BARS))
          RAM_BARS_EMPTY=""
          [ $RAM_EMPTY -gt 0 ] && RAM_BARS_EMPTY=$(printf '‚ñë%.0s' $(seq 1 $RAM_EMPTY))
          
          # RAM formatted values (with safe division to avoid inf/nan)
          # Validate all variables to prevent division errors
          if [ "$RAM_TOTAL" -gt 0 ] && [ -n "$RAM_AVAILABLE" ] && [ -n "$RAM_USED" ]; then
            RAM_AVAILABLE_KB=$(awk "BEGIN {printf \"%.2f\", ${RAM_AVAILABLE}/1024}")
            RAM_TOTAL_KB=$(awk "BEGIN {printf \"%.2f\", ${RAM_TOTAL}/1024}")
            RAM_USED_KB=$(awk "BEGIN {printf \"%.2f\", ${RAM_USED}/1024}")
          else
            RAM_AVAILABLE_KB="0.00"
            RAM_TOTAL_KB="0.00"
            RAM_USED_KB="0.00"
          fi
          
          # Compression saved space
          COMPRESSION_SAVED_KB=$(awk "BEGIN {printf \"%.0f\", ${ORIGINAL_SIZE_KB} - ${COMPRESSED_SIZE_KB}}")
          
          # Create the summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ‚úÖ Build successful
          
          The firmware has been compiled successfully and is ready for deployment.
          
          ## üì¶ Project Information
          
          | Property | Value |
          |----------|-------|
          | üìù **Sketch Name** | **\`${SKETCH_NAME}\`** |
          | üéØ **Board** | \`esp8266:esp8266:generic\` |
          | üíæ **Flash Size** | **${FLASH_SIZE_MB} MB** |
          | üïê **Build Time** | ${BUILD_TIME} |
          | üîñ **Commit** | [\`${COMMIT_SHA_FULL}\`](https://github.com/${REPO}/commit/${COMMIT_SHA_FULL}) |
          
          <details>
          <summary>‚öôÔ∏è Frequency Configuration (click to expand)</summary>
          
          | Property | Value |
          |----------|-------|
          | ‚ö° **CPU Frequency** | ${CPU_FREQ} MHz |
          | üîÆ **Crystal Frequency** | ${CRYSTAL_FREQ} MHz |
          | üì° **Flash Mode** | ${FLASH_MODE^^} @ ${FLASH_FREQ} MHz |
          
          </details>

          <details>
          <summary>üîß Build Configuration (Click to expand)</summary>
          
          ### Build Flags
          \`\`\`
          ${BUILD_FLAGS}
          \`\`\`
          
          ### Board Parameters
          \`\`\`
          ${BOARD_PARAMS}
          \`\`\`
          
          </details>
          
          <details>
          <summary>üìö Used Libraries (Click to expand)</summary>
          
          The following libraries were used in this build (as specified in \`sketch.yaml\`):
          
          | Library Name | Version |
          |--------------|---------|
          ${LIBRARY_LIST}
          
          </details>
          
          **üî© Platform Core:** [\`${PLATFORM_VERSION}\`](https://github.com/esp8266/Arduino/releases/tag/${PLATFORM_VERSION})
          
          ## üíæ Flash Memory Usage
          
          | Metric | Value |
          |--------|-------|
          | üìä **Flash Usage** | ![${FLASH_USAGE_PCT}% Used](https://geps.dev/progress/${FLASH_USAGE_PCT}?dangerColor=dc3545&warningColor=ffc107&successColor=28a745) |
          | ‚úÖ **Available Space** | ${FLASH_AVAILABLE_KB} KB |
          | üì¶ **Total Flash** | ${FLASH_TOTAL_KB} KB |
          
          ## üß† RAM (SRAM) Usage
          
          | Metric | Value |
          |--------|-------|
          | üìä **RAM Usage** | ![${RAM_USAGE_PCT}% Used](https://geps.dev/progress/${RAM_USAGE_PCT}?dangerColor=dc3545&warningColor=ffc107&successColor=28a745) |
          | üîß **Used by Globals** | ${RAM_USED_KB} KB (${RAM_USED} bytes) |
          | ‚úÖ **Available RAM** | ${RAM_AVAILABLE_KB} KB (${RAM_AVAILABLE} bytes) |
          | üì¶ **Total RAM** | ${RAM_TOTAL_KB} KB (${RAM_TOTAL} bytes) |
          
          ## üìä Binary File Details
          
          | üì¶ File Type | Size | üîê MD5 Hash | üîó Download URL |
          |---------------|------|--------------|-----------------|
          | üìÑ **Original Binary** | **${ORIGINAL_SIZE_KB} KB** ($(printf "%'d" ${ORIGINAL_SIZE} 2>/dev/null || echo ${ORIGINAL_SIZE}) bytes) | \`${MD5_UNCOMPRESSED}\` | _N/A_ |
          | üóÑÔ∏è **Compressed (gzip)** | **${COMPRESSED_SIZE_KB} KB** ($(printf "%'d" ${COMPRESSED_SIZE} 2>/dev/null || echo ${COMPRESSED_SIZE}) bytes) | \`${MD5_COMPRESSED}\` | üì• **[Download Firmware](${ARTIFACT_URL})** |
          
          **üìà Compression Ratio:** **\`${COMPRESSION_RATIO}%\`** (saved ${COMPRESSION_SAVED_KB} KB) - using gzip level 9
          
          ### üì¶ Artifact Contents
          
          The compiled and compressed firmware binary is available as a workflow artifact along with MD5 checksums and build metadata.
          - \`${SKETCH_NAME}.bin\` - Compressed firmware binary (gzip)
          - \`${SKETCH_NAME}.bin.md5\` - MD5 checksums for verification
          - \`build-info.txt\` - Build configuration and metadata
          
          ## ‚úÖ Integrity Verification
          
          To verify the firmware integrity after download, use one of these methods:
          
          ### Verify Compressed Binary (recommended)
          \`\`\`bash
          echo "${MD5_COMPRESSED}  ${SKETCH_NAME}.bin" | md5sum -c
          \`\`\`
          
          ### Verify Original Binary (decompress first)
          \`\`\`bash
          gunzip -c ${SKETCH_NAME}.bin > ${SKETCH_NAME}.bin.uncompressed
          echo "${MD5_UNCOMPRESSED}  ${SKETCH_NAME}.bin.uncompressed" | md5sum -c
          \`\`\`

          ## üí° Usage Visualization
          
          \`\`\`
          Flash: [${FLASH_BARS_FILLED}${FLASH_BARS_EMPTY}] ${FLASH_USAGE_PCT}%
          RAM:   [${RAM_BARS_FILLED}${RAM_BARS_EMPTY}] ${RAM_USAGE_PCT}%
          \`\`\`
          
          ## üìö Additional Information
          
          - **Build System:** [Arduino CLI](https://arduino.github.io/arduino-cli/)
          - **Platform:** [ESP8266 Arduino Core](https://github.com/esp8266/Arduino)
          - **Workflow:** [Build Workflow](.github/workflows/build.yml)
          - **Repository:** [${REPO}](https://github.com/${REPO})
          
          ---
          
          ‚ú® *Automatically built by GitHub Actions ‚Ä¢ [View Run](https://github.com/${REPO}/actions/runs/${RUN_ID})*
          EOF
          
          echo "‚úÖ Build summary generated successfully"
