name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          # Clone to a directory with the same name to match the sketch file (Arduino CLI requirement)
          path: ASA0002E

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Create Arduino CLI config
        working-directory: ASA0002E
        run: |
          mkdir -p .vscode
          cat > .vscode/arduino-cli.yaml << 'EOF'
          directories:
            data: ~/.arduino15
            downloads: ~/.arduino15/staging
            user: ~/Arduino
          board_manager:
            additional_urls:
              - https://arduino.esp8266.com/stable/package_esp8266com_index.json
          EOF
          # Remove leading spaces from the YAML file
          sed -i 's/^          //' .vscode/arduino-cli.yaml

      - name: Install ESP8266 platform
        working-directory: ASA0002E
        run: |
          arduino-cli --config-file .vscode/arduino-cli.yaml core update-index
          # Extract platform version from sketch.yaml using sed (more portable)
          # Format: "platform: esp8266:esp8266 (3.1.2)"
          PLATFORM_VERSION=$(grep 'platform: esp8266:esp8266' sketch.yaml | sed 's/.*(\([0-9.]*\)).*/\1/' 2>/dev/null)
          # Validate version format (should be digits and dots only)
          if ! echo "$PLATFORM_VERSION" | grep -qE '^[0-9]+\.[0-9]+(\.[0-9]+)?$'; then
            echo "Warning: Could not extract valid platform version, using default 3.1.2"
            PLATFORM_VERSION="3.1.2"
          fi
          echo "Installing ESP8266 platform version: ${PLATFORM_VERSION}"
          arduino-cli --config-file .vscode/arduino-cli.yaml core install "esp8266:esp8266@${PLATFORM_VERSION}"

      - name: Install required libraries from sketch.yaml
        working-directory: ASA0002E
        run: |
          # Parse libraries from sketch.yaml and install them
          # Only match lines after "libraries:" that start with "- " and have format "LibraryName (version)"
          # Exclude lines containing "platform:" to avoid matching platform entries
          grep -A100 'libraries:' sketch.yaml | grep -E '^\s+-\s+[^:]+\([^)]+\)' | grep -v 'platform:' | while read -r line; do
            # Extract library name (everything before the last '(' with version)
            lib_name=$(echo "$line" | sed -E 's/^\s*-\s*(.+)\s*\([^)]+\)\s*$/\1/' | sed 's/[[:space:]]*$//')
            # Extract version (content inside the last parentheses)
            lib_version=$(echo "$line" | sed -E 's/.*\(([^)]+)\).*/\1/')
            echo "Installing library: ${lib_name}@${lib_version}"
            arduino-cli --config-file .vscode/arduino-cli.yaml lib install "${lib_name}@${lib_version}" || \
              arduino-cli --config-file .vscode/arduino-cli.yaml lib install "${lib_name}"
          done

      - name: Build firmware
        working-directory: ASA0002E
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Upload build artifacts
        id: upload_artifacts
        uses: actions/upload-artifact@v6
        with:
          name: firmware
          path: |
            ASA0002E/Build/*.bin
            ASA0002E/Build/*.md5
            ASA0002E/Build/build-info.txt
          if-no-files-found: error

      - name: Generate build summary
        working-directory: ASA0002E
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Load build information
          if [ -f Build/build-info.txt ]; then
            source Build/build-info.txt
          else
            echo "Error: Build/build-info.txt not found. Ensure build.sh generated this file before running the build summary step." >&2
            exit 1
          fi
          
          BIN_FILE="Build/${SKETCH_NAME}.bin"
          MD5_FILE="Build/${SKETCH_NAME}.bin.md5"
          
          # Read MD5 hashes
          MD5_UNCOMPRESSED=$(grep -v "compressed" "$MD5_FILE" | awk '{print $1}')
          MD5_COMPRESSED=$(grep "compressed" "$MD5_FILE" | awk '{print $1}')
          
          # Get build timestamp
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Get repository info
          REPO="${GITHUB_REPOSITORY}"
          COMMIT_SHA_FULL="${GITHUB_SHA}"
          RUN_ID="${GITHUB_RUN_ID}"
          
          # Fetch artifact download URL using GitHub API
          echo "üîç Fetching artifact download URL..."
          ARTIFACT_URL=""
          MAX_RETRIES=5
          DELAY=2
          
          # Retry fetching artifacts until the "firmware" artifact is available or retries are exhausted
          for ((i=1; i<=MAX_RETRIES; i++)); do
            echo "üîÅ Attempt $i to fetch artifacts for run ${RUN_ID}..."
            ARTIFACTS_JSON=$(curl -s -H "Authorization: token ${GH_TOKEN}" \
              "https://api.github.com/repos/${REPO}/actions/runs/${RUN_ID}/artifacts")
          
            # Extract the artifact ID for "firmware" artifact using jq if available, otherwise grep
            if command -v jq &> /dev/null; then
              ARTIFACT_ID=$(echo "$ARTIFACTS_JSON" | jq -r '.artifacts[] | select(.name == "firmware") | .id' 2>/dev/null || echo "")
            else
              # Fallback to grep-based parsing
              ARTIFACT_ID=$(echo "$ARTIFACTS_JSON" | grep -A 5 '"name": "firmware"' | grep '"id":' | head -1 | grep -oP '\d+' || echo "")
            fi
          
            if [ -n "$ARTIFACT_ID" ]; then
              break
            fi
          
            if [ "$i" -lt "$MAX_RETRIES" ]; then
              echo "‚è±Ô∏è Artifact not found yet, waiting ${DELAY}s before retrying..."
              sleep "$DELAY"
              DELAY=$((DELAY * 2))
            fi
          done
          
          if [ -n "$ARTIFACT_ID" ]; then
            ARTIFACT_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}/artifacts/${ARTIFACT_ID}"
            echo "‚úÖ Artifact URL: $ARTIFACT_URL"
          else
            echo "‚ö†Ô∏è Could not fetch artifact URL, using run page"
            ARTIFACT_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
          fi
          
          # Calculate sizes in different units
          ORIGINAL_SIZE_KB=$(awk "BEGIN {printf \"%.2f\", ${ORIGINAL_SIZE}/1024}")
          COMPRESSED_SIZE_KB=$(awk "BEGIN {printf \"%.2f\", ${COMPRESSED_SIZE}/1024}")
          FLASH_TOTAL_KB=$(awk "BEGIN {printf \"%.0f\", ${FLASH_SIZE_MB}*1024}")
          FLASH_AVAILABLE_KB=$(awk "BEGIN {printf \"%.2f\", ${FLASH_TOTAL_KB} - ${COMPRESSED_SIZE_KB}}")
          
          # Extract key board parameters for display
          # Default values: CPU=80MHz, Crystal=26MHz, Flash=40MHz/QIO
          CRYSTAL_FREQ=$(echo "$BOARD_PARAMS" | grep -oP 'CrystalFreq=\K[^,]+' || echo "26")
          FLASH_FREQ=$(echo "$BOARD_PARAMS" | grep -oP 'FlashFreq=\K[^,]+' || echo "40")
          FLASH_MODE=$(echo "$BOARD_PARAMS" | grep -oP 'FlashMode=\K[^,]+' || echo "qio")
          CPU_FREQ=$(echo "$BOARD_PARAMS" | grep -oP 'xtal=\K[^,]+' || echo "80")
          
          # Create the summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ‚úÖ Build successful
          
          The firmware has been compiled successfully and is ready for deployment.
          
          ## üì¶ Project Information
          
          | Property | Value |
          |----------|-------|
          | üìù **Sketch Name** | \`${SKETCH_NAME}\` |
          | üéØ **Board** | \`esp8266:esp8266:generic\` |
          | üíæ **Flash Size** | ${FLASH_SIZE_MB} MB |
          | üïê **Build Time** | ${BUILD_TIME} |
          | üîñ **Commit** | [\`${COMMIT_SHA_FULL}\`](https://github.com/${REPO}/commit/${COMMIT_SHA_FULL}) |
          
          <details>
          <summary>‚öôÔ∏è Frequency Configuration (click to expand)</summary>
          
          | Property | Value |
          |----------|-------|
          | ‚ö° **CPU Frequency** | ${CPU_FREQ} MHz |
          | üîÆ **Crystal Frequency** | ${CRYSTAL_FREQ} MHz |
          | üì° **Flash Mode** | ${FLASH_MODE^^} @ ${FLASH_FREQ} MHz |
          
          </details>

          <details>
          <summary>üîß Build Configuration (Click to expand)</summary>
          
          ### Build Flags
          \`\`\`
          ${BUILD_FLAGS}
          \`\`\`
          
          ### Board Parameters
          \`\`\`
          ${BOARD_PARAMS}
          \`\`\`
          
          </details>
          
          ## üíæ Flash Memory Usage
          
          | Metric | Value |
          |--------|-------|
          | üìä **Flash Usage** | ![*${FLASH_USAGE_PCT}% Used](https://geps.dev/progress/${FLASH_USAGE_PCT}?dangerColor=dc3545&warningColor=ffc107&successColor=28a745) of ${FLASH_SIZE_MB} MB |
          | ‚úÖ **Available Space** | ${FLASH_AVAILABLE_KB} KB |
          | üì¶ **Total Flash** | ${FLASH_TOTAL_KB} KB |
          
          ## üìä Binary File Details
          
          | üì¶ File Type | Size | üîê MD5 Hash | üîó Download URL |
          |---------------|-----|--------------|-----------------|
          | üìÑ **Original Binary** | ${ORIGINAL_SIZE_KB} (_${ORIGINAL_SIZE}_ bytes) | \`${MD5_UNCOMPRESSED}\` | |
          | üóÑÔ∏è **Compressed (gzip)** | ${COMPRESSED_SIZE_KB} (_${COMPRESSED_SIZE}_ bytes) | \`${MD5_COMPRESSED}\` | üì• **[Download Firmware](${ARTIFACT_URL})** |
          
          ### Compression Statistics
          
          - **Compression Ratio:** **\`${COMPRESSION_RATIO}%\`** (saved $(awk "BEGIN {printf \"%.2f\", ${ORIGINAL_SIZE_KB} - ${COMPRESSED_SIZE_KB}}") KB, using gzip level 9)
          
          The compiled and compressed firmware binary is available as a workflow artifact along with MD5 checksums and build metadata.
          
          ### üì¶ Artifact Contents
          
          - \`${SKETCH_NAME}.bin\` - Compressed firmware binary (gzip)
          - \`${SKETCH_NAME}.bin.md5\` - MD5 checksums for verification
          - \`build-info.txt\` - Build configuration and metadata
          
          ## ‚úÖ Integrity Verification
          
          To verify the firmware integrity after download, use one of these methods:
          
          ### Verify Compressed Binary (recommended)
          \`\`\`bash
          echo "${MD5_COMPRESSED}  ${SKETCH_NAME}.bin" | md5sum -c
          \`\`\`
          
          ### Verify Original Binary (decompress first)
          \`\`\`bash
          gunzip -c ${SKETCH_NAME}.bin > ${SKETCH_NAME}.bin.uncompressed
          echo "${MD5_UNCOMPRESSED}  ${SKETCH_NAME}.bin.uncompressed" | md5sum -c
          \`\`\`

          ### Usage Visualization
          
          \`\`\`
          Flash: [$(printf '‚ñà%.0s' $(seq 1 $((FLASH_USAGE_PCT/2))))$(printf '‚ñë%.0s' $(seq 1 $((50-FLASH_USAGE_PCT/2))))] ${FLASH_USAGE_PCT}%
          \`\`\`
          
          ## üìö Additional Information
          
          - **Build System:** [Arduino CLI](https://arduino.github.io/arduino-cli/)
          - **Platform:** ESP8266 Arduino Core
          - **Workflow:** [Build Workflow](.github/workflows/build.yml)
          - **Repository:** [${REPO}](https://github.com/${REPO})
          
          ---
          
          ‚ú® *Automatically built by GitHub Actions ‚Ä¢ [View Run](https://github.com/${REPO}/actions/runs/${RUN_ID})*
          EOF
          
          echo "‚úÖ Build summary generated successfully"
