name: Dependency Updates

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      check_only:
        description: 'Only check for updates (do not create PR)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Check for library and platform updates
        id: check_updates
        run: |
          chmod +x upgrade.sh
          
          if [ "${{ github.event.inputs.check_only }}" = "true" ]; then
            ./upgrade.sh --check 2>&1 | tee upgrade_output.txt
          else
            ./upgrade.sh 2>&1 | tee upgrade_output.txt
          fi
          
          # Check if updates were applied
          if grep -q "UPDATES_APPLIED=true" upgrade_output.txt; then
            echo "updates_applied=true" >> $GITHUB_OUTPUT
          else
            echo "updates_applied=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if updates are available
          if grep -q "UPDATES_AVAILABLE=true" upgrade_output.txt; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
          fi
          
          # Extract update information for summary
          # Parse lines like: "Library xyz: 1.0.0 -> 1.1.0" or "Platform xyz: ..."
          echo "UPDATE_DETAILS<<EOF" >> $GITHUB_OUTPUT
          grep -E "(Library|Platform).*:.*->" upgrade_output.txt | sed 's/\[WARNING\] //' >> $GITHUB_OUTPUT || echo "No updates found" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Show sketch.yaml changes
        if: steps.check_updates.outputs.updates_applied == 'true'
        run: |
          echo "Changes to sketch.yaml:"
          git diff sketch.yaml

      - name: Create Pull Request
        id: create_pr
        if: steps.check_updates.outputs.updates_applied == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Arduino libraries and platform versions"
          title: "chore: Automatic dependency updates"
          body: |
            ## ðŸ”„ Automatic Dependency Updates
            
            This PR was automatically generated by the dependency update workflow.
            
            ### ðŸ“¦ Updated Dependencies
            
            The following dependencies have been updated to their latest versions:
            
            ${{ steps.check_updates.outputs.UPDATE_DETAILS }}
            
            ### ðŸ“‹ What to do
            1. ðŸ‘€ Review the changes in `sketch.yaml`
            2. âœ… Verify that the build workflow passes
            3. ðŸš€ Merge this PR to apply the updates
            
            ### ðŸ”— Related Links
            - [sketch.yaml](sketch.yaml) - Updated dependency configuration
            - [Build Workflow](.github/workflows/build.yml) - Will validate these changes
            - [Arduino Library Index](https://www.arduino.cc/reference/en/libraries/)
            - [ESP8266 Arduino Core](https://github.com/esp8266/Arduino)
            
            ---
            
            ðŸ¤– *This PR was created by the [Dependency Updates](.github/workflows/update-dependencies.yml) workflow.*
          branch: auto-update/dependencies
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Generate dependency update summary
        if: always()
        run: |
          # Get repository info
          REPO="${GITHUB_REPOSITORY}"
          RUN_ID="${GITHUB_RUN_ID}"
          WORKFLOW_NAME="Dependency Updates"
          RUN_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Start building summary
          cat >> $GITHUB_STEP_SUMMARY << 'HEADER'
          # ðŸ”„ Dependency Update Report
          
          HEADER
          
          # Main status section
          if [ "${{ steps.check_updates.outputs.updates_applied }}" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âœ… Updates Applied Successfully
          
          Dependencies have been updated and a pull request has been created.
          
          EOF
            
            # Add PR information if available
            if [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ### ðŸ”— Pull Request
          
          **PR #${{ steps.create_pr.outputs.pull-request-number }}**: [View Pull Request](https://github.com/${REPO}/pull/${{ steps.create_pr.outputs.pull-request-number }})
          
          EOF
            fi
            
          elif [ "${{ steps.check_updates.outputs.updates_available }}" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## â„¹ï¸ Updates Available (Check-Only Mode)
          
          Updates are available but were not applied because this was run in check-only mode.
          
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âœ… All Dependencies Up-to-Date
          
          No updates are available. All dependencies are already at their latest versions.
          
          EOF
          fi
          
          # Parse and display update details in a table
          if [ -f upgrade_output.txt ]; then
            # Extract library updates
            LIBRARY_UPDATES=$(grep "Library" upgrade_output.txt | grep -E "->|up to date" | sed 's/\[SUCCESS\] /âœ… /' | sed 's/\[WARNING\] /âš ï¸ /' 2>/dev/null || true)
            
            # Extract platform updates
            PLATFORM_UPDATES=$(grep "Platform" upgrade_output.txt | grep -E "->|up to date" | sed 's/\[SUCCESS\] /âœ… /' | sed 's/\[WARNING\] /âš ï¸ /' 2>/dev/null || true)
            
            if [ -n "$LIBRARY_UPDATES" ] || [ -n "$PLATFORM_UPDATES" ]; then
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“Š Update Details
          
          ### ðŸ“š Libraries
          
          | Status | Library | Version Change |
          |--------|---------|----------------|
          EOF
              
              # Process library updates into table format
              echo "$LIBRARY_UPDATES" | while IFS= read -r line; do
                if [ -n "$line" ]; then
                  # Check if it's an update or already up-to-date
                  if echo "$line" | grep -q "->"; then
                    # Extract: Library Name: old -> new
                    LIB_NAME=$(echo "$line" | sed -E 's/.*Library ([^:]+):.*/\1/')
                    OLD_VER=$(echo "$line" | sed -E 's/.*: ([^ ]+) ->.*/\1/')
                    NEW_VER=$(echo "$line" | sed -E 's/.*-> ([^ ]+).*/\1/')
                    echo "| â¬†ï¸ | **${LIB_NAME}** | \`${OLD_VER}\` â†’ \`${NEW_VER}\` |" >> $GITHUB_STEP_SUMMARY
                  elif echo "$line" | grep -q "up to date"; then
                    # Extract: Library Name: version (up to date)
                    LIB_NAME=$(echo "$line" | sed -E 's/.*Library ([^:]+):.*/\1/')
                    VERSION=$(echo "$line" | sed -E 's/.*: ([^ ]+) .*/\1/')
                    echo "| âœ… | **${LIB_NAME}** | \`${VERSION}\` (current) |" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
              
              cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          
          ### ðŸ”§ Platform
          
          | Status | Platform | Version Change |
          |--------|----------|----------------|
          EOF
              
              # Process platform updates into table format
              echo "$PLATFORM_UPDATES" | while IFS= read -r line; do
                if [ -n "$line" ]; then
                  if echo "$line" | grep -q "->"; then
                    PLATFORM_NAME=$(echo "$line" | sed -E 's/.*Platform ([^:]+):.*/\1/')
                    OLD_VER=$(echo "$line" | sed -E 's/.*: ([^ ]+) ->.*/\1/')
                    NEW_VER=$(echo "$line" | sed -E 's/.*-> ([^ ]+).*/\1/')
                    echo "| â¬†ï¸ | **${PLATFORM_NAME}** | \`${OLD_VER}\` â†’ \`${NEW_VER}\` |" >> $GITHUB_STEP_SUMMARY
                  elif echo "$line" | grep -q "up to date"; then
                    PLATFORM_NAME=$(echo "$line" | sed -E 's/.*Platform ([^:]+):.*/\1/')
                    VERSION=$(echo "$line" | sed -E 's/.*: ([^ ]+) .*/\1/')
                    echo "| âœ… | **${PLATFORM_NAME}** | \`${VERSION}\` (current) |" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          fi
          
          # Add summary table
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ## ðŸ“‹ Summary
          
          | Metric | Value |
          |--------|-------|
          | ðŸ• **Run Time** | ${RUN_TIME} |
          | ðŸ”„ **Workflow** | [${WORKFLOW_NAME}](.github/workflows/update-dependencies.yml) |
          | ðŸ”— **Run ID** | [${RUN_ID}](https://github.com/${REPO}/actions/runs/${RUN_ID}) |
          | ðŸ“¦ **Mode** | ${{ github.event.inputs.check_only == 'true' && 'Check Only' || 'Apply Updates' }} |
          | âœ… **Status** | ${{ steps.check_updates.outputs.updates_applied == 'true' && 'Updates Applied' || steps.check_updates.outputs.updates_available == 'true' && 'Updates Available' || 'Up-to-Date' }} |
          
          ## ðŸ“š Resources
          
          - ðŸ“– [Arduino Library Manager](https://www.arduino.cc/reference/en/libraries/)
          - ðŸ”§ [ESP8266 Arduino Core Documentation](https://arduino-esp8266.readthedocs.io/)
          - ðŸ“¦ [ESP8266 Package Index](https://arduino.esp8266.com/stable/package_esp8266com_index.json)
          - ðŸ¤– [Dependabot Configuration](.github/dependabot.yml)
          
          ---
          
          âœ¨ *Automated dependency management â€¢ [View Workflow](.github/workflows/update-dependencies.yml)*
          EOF
          
          echo "âœ… Dependency update summary generated"

      - name: Summary
        if: false  # Disabled in favor of comprehensive summary above
        run: |
          if [ "${{ steps.check_updates.outputs.updates_applied }}" = "true" ]; then
            echo "### âœ… Updates Applied" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with the dependency updates." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_updates.outputs.updates_available }}" = "true" ]; then
            echo "### â„¹ï¸ Updates Available" >> $GITHUB_STEP_SUMMARY
            echo "Updates are available but were not applied (check-only mode)." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All Up to Date" >> $GITHUB_STEP_SUMMARY
            echo "All dependencies are already at their latest versions." >> $GITHUB_STEP_SUMMARY
          fi
